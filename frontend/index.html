<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de Gestión de Pollo - Múltiples Dashboards">
    <title>Sistema de Gestión - Dashboard</title>
    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="css/output.css">

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="assets/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="css/dashboard-styles.css">

    <style>
        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 300px;
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            transition: transform 0.3s ease, width 0.3s ease;
            z-index: 1000;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .sidebar.collapsed {
            width: 0;
            overflow: hidden;
        }

        .toggle-sidebar-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .toggle-sidebar-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .menu-item {
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            min-height: 48px;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: none;
        }

        .menu-item.active {
            background: rgba(255, 255, 255, 0.15);
            border-left: 4px solid #60a5fa;
        }

        /* Alineación del contenido del item */
        .menu-item>span {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
            flex: 1;
        }

        .menu-item>span>span {
            display: block;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.3;
            text-align: left;
        }

        .menu-item>span>i {
            flex-shrink: 0;
            width: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-item>i {
            flex-shrink: 0;
            margin-left: auto;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* estado activo para enlaces y botones */
        .menu-link.active,
        .menu-item.active,
        .submenu-toggle.active {
            color: white !important;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
            font-weight: 600;
        }

        /* alternativa visual: sombra / fondo para botones activos */
        .menu-item.active,
        .submenu-toggle.active {
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 4 6px 18px rgba(0, 0, 0, 0.25);
        }

        /* Submenu */
        .submenu.hidden {
            display: none !important;
        }

        .submenu:not(.hidden) {
            display: block;
        }

        .menu-link {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
        }

        .submenu-toggle {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.3;
        }

        /* Content area */
        .content-wrapper {
            margin-left: 300px;
            transition: margin-left 0.3s ease;
        }


        @media (min-width: 1024px) {
            .sidebar {
                transform: translateX(0);
            }

            /* .content-wrapper {
                margin-left: 300px;
            }*/

            .sidebar-overlay {
                display: none;
            }

            .menu-toggle-mobile {
                display: none;
            }
        }

        @media (max-width: 1023px) {
            .content-wrapper {
                margin-left: 0;
            }
        }

        /* Animaciones */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease;
        }

        /* Dashboard iframe */
        #dashboardFrame {
            width: 100%;
            min-height: calc(100vh - 80px);
            border: none;
            background: #f9fafb;
        }

        /* Loading */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .content-wrapper.sidebar-collapsed {
            margin-left: 0;
        }
    </style>
</head>

<body class="bg-gray-100">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
        <!-- Logo/Header -->
        <div class="p-6 border-b border-blue-700">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-white font-bold text-lg">Sistema</h2>
                        <p class="text-blue-300 text-xs">Gestión </p>
                    </div>
                </div>
                <button onclick="toggleSidebarCollapse()" class="lg:hidden text-white hover:text-blue-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Menu -->
        <!-- Navbar actualizado -->
        <nav class="p-4 space-y-2 overflow-y-auto" style="max-height: calc(100vh - 130px);">
            <div class="mb-4">
                <p class="text-blue-300 text-xs uppercase font-semibold mb-2 px-3">Dashboards</p>
            </div>

            <!-- INFORMACIÓN DEL MERCADO -->
            <div class="menu-group">
                <button class="menu-item flex items-center justify-between w-full px-4 py-3 text-white rounded-lg"
                    onclick="toggleSubmenu('submenu-mercado')">
                    <span class="flex items-center gap-3">
                        <i class="fas fa-shopping-cart w-5"></i>
                        <span class="font-medium">1.- Información del Mercado</span>
                    </span>
                    <i class="fas fa-chevron-down text-sm"></i>
                </button>

                <div id="submenu-mercado" class="submenu hidden pl-10 mt-2 space-y-2">

                    <a href="#"
                        onclick="selectMenuItem(this); loadDashboardAndData('dashboard-comercializacion.html','vivo-aqp', 'Gestion Vivo Arequipa')"
                        class="menu-link block text-gray-400 hover:text-white">Vivo Arequipa</a>
                </div>
            </div>

            <div class="menu-group">
                <button class="menu-item flex items-center justify-between w-full px-4 py-3 text-white rounded-lg"
                    onclick="activateAndLoad(this, 'dashboard-control-objetivos.html', 'gestion-objetivos', 'Gestión de Objetivos')">
                    <span class="flex items-center gap-3">
                        <i class="fas fa-seedling w-5"></i>
                        <span class="font-medium">2.- Gestion de objetivos</span>
                    </span>
                </button>
            </div>

        </nav>


        <script>
            function toggleSubmenu(id, btn) {
                const el = document.getElementById(id);
                if (!el) return;

                el.classList.toggle('hidden');

                // si se pasó el botón, alternar su clase active (no limpiar los otros)
                if (btn) {
                    btn.classList.toggle('active');
                }
            }
        </script>

    </aside>

    <!-- Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebarCollapse()"></div>

    <!-- Main Content -->
    <div class="content-wrapper">
        <!-- Top Bar -->
        <header class="bg-white shadow-sm sticky top-0 z-50">
            <div class="px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">

                    <!-- Botón PARA DESKTOP (ocultar sidebar) -->
                    <button class="" onclick="toggleSidebarCollapse()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h1 id="" class="text-2xl font-bold text-gray-800">Sistema de Gestion GRS</h1>
                        <p id="dashboardTitle" class="text-sm text-gray-500"></p>
                    </div>

                </div>

                <!-- User Dropdown -->
                <details class="relative">
                    <summary class="flex items-center gap-3 cursor-pointer select-none list-none">
                        <div class="text-right">
                            <p id="userName" class="text-sm font-semibold text-gray-700">Usuario Admin</p>
                            <p id="rolUser" class="text-xs text-gray-500">Administrador</p>
                        </div>
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white"></i>
                        </div>
                    </summary>

                    <div class="absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded-lg shadow-lg">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-user text-gray-500 mr-2"></i> Perfil
                        </a>
                        <hr class="border-gray-200 my-1" />
                        <a href="#" onclick="cerrarSesion()"
                            class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                            <i class="fas fa-sign-out-alt mr-2"></i> Cerrar sesión
                        </a>
                    </div>
                </details>
            </div>
        </header>


        <!-- Dashboard Content -->
        <main class="p-6 relative">
            <div id="loadingIndicator" class="loading hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>

            <iframe id="dashboardFrame" src="dashboard-capturas.html" onload="hideLoading()">
            </iframe>
        </main>
    </div>

    <script>
        // Toggle Sidebar


        // Load Dashboard
        function loadDashboard(url, element) {
            // Prevenir comportamiento por defecto del enlace
            event.preventDefault();

            // Mostrar loading
            showLoading();

            // Actualizar menu activo
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');

            // Cargar dashboard
            const frame = document.getElementById('dashboardFrame');
            frame.src = url;

            // Actualizar título
            const titles = {
                'dashboard-capturas.html': 'Capturas de Pantalla',
                'dashboard-comercializacion.html': 'Información del Mercado'
            };
            document.getElementById('dashboardTitle').textContent = titles[url] || 'Dashboard';

            // Cerrar sidebar en móvil
            if (window.innerWidth < 1024) {
                toggleSidebarCollapse();
            }
        }

        //FUNCION CLAVE PARA CARGAR LAS VENTANAS 
        //SE LE PASA EL NOMBRE DEL ARCHIVO QUE SE DESEA CARGAR Y SI TIENE SUB TIPOS LE VAMOS EL TIPO
        //COMO POR EJEMPLO ('DASHBOARD-COMERCIO', 'TIPOCOMERCIO')
        function loadDashboardAndData(dashboardUrl, tipo, title) {
            const frame = document.getElementById('dashboardFrame');
            const titulo = document.getElementById('dashboardTitle');
            //se adiciona el dashboard al array de titulos para cargar el titulo
            const titles = {
                'dashboard-capturas.html': 'Gestion ' + title,
                //'dashboard-comercializacion.html': title,
                //'dashboard-vivo-arequipa.html': 'Gestion Provincia',
                //'dashboard-vivo-provincia.html': 'Gestion Arequipa',

                //'dashboard_tamanoMercado.html': 'Gestion Tamaño de Mercado',
                'dashboard-control-objetivos.html': title

            };

            titulo.textContent = titles[dashboardUrl] || 'Dashboard';
            showLoading();

            /*Aqui tener en cuenta que el dashboard cargado debe tener la funcion
                "cargarDatos()" esta se encarga de cargar la tabla y demas data que se
                desea mostrar, tener en cuenta la esctructua de JS
                dashboarh.html -> controller -> service-> config
            */

            const run = () => {
                try {
                    if (frame.contentWindow && typeof frame.contentWindow.cargarDatos === 'function') {
                        frame.contentWindow.cargarDatos(tipo);
                    } else {
                        /*console.error("La función cargarDatos no existe en el iframe.");*/
                    }
                } finally {
                    hideLoading();
                }
            };

            if (frame.src.includes(dashboardUrl)) {
                // ya está cargado ese dashboard
                run();
            } else {
                // esperar a que el nuevo dashboard se cargue
                frame.onload = run;
                frame.src = dashboardUrl;
            }

            if (window.innerWidth < 1024) toggleSidebarCollapse();
        }

        // Loading functions
        function showLoading() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        // Responsive: cerrar sidebar al hacer clic fuera
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024) {
                document.getElementById('sidebar').classList.add('open');
                document.getElementById('sidebarOverlay').classList.remove('active');
            }
        });

        // Inicializar sidebar abierto en desktop
        if (window.innerWidth >= 1024) {
            document.getElementById('sidebar').classList.add('open');
        }

        // limpia y marca el elemento activo y su posible padre toggle
        function markActiveElement(element) {
            // quitar active de todos
            document.querySelectorAll('.menu-link.active, .menu-item.active, .submenu-toggle.active')
                .forEach(el => el.classList.remove('active'));

            if (!element) return;

            // marca el elemento clickeado (si es link o botón)
            element.classList.add('active');

            // si el elemento es un link dentro de un submenu, marcar también el botón padre que abre ese submenu
            const parentToggle = findParentToggleButton(element);
            if (parentToggle) parentToggle.classList.add('active');

            // además marcar el menu-group superior (si existe un .menu-item dentro del grupo)
            const menuGroup = element.closest('.menu-group');
            if (menuGroup) {
                const topMenuItem = menuGroup.querySelector('.menu-item');
                if (topMenuItem) topMenuItem.classList.add('active');
            }
        }

        // buscar el botón toggle que controla el submenu donde está el elemento
        function findParentToggleButton(el) {
            let node = el;
            while (node && node !== document) {
                // si el padre más cercano es un submenu, intentamos buscar un botón anterior en ese mismo contenedor
                if (node.classList && node.classList.contains('submenu')) {
                    // buscar botón previo (por ejemplo: <button ...> </button> seguido por <div class="submenu">)
                    let prev = node.previousElementSibling;
                    if (prev && prev.tagName === 'BUTTON') return prev;
                }
                node = node.parentElement;
            }

            // alternativa: buscar un botón con clase .submenu-toggle dentro el ancestro directo
            node = el.closest('.menu-group');
            if (node) {
                const innerToggle = node.querySelector('.submenu-toggle');
                if (innerToggle) return innerToggle;
            }

            return null;
        }

        // función que usan tus links (ya la tenías, la adaptamos a markActiveElement)
        function selectMenuItem(element) {
            markActiveElement(element);
        }

        // función que usaremos en botones que cargan dashboard directamente
        function activateAndLoad(buttonOrLink, dashboardUrl, tipo, title) {
            // marcar UI
            markActiveElement(buttonOrLink);

            // llamar a tu función existente que carga el iframe
            loadDashboardAndData(dashboardUrl, tipo, title);
        }

        window.addEventListener('DOMContentLoaded', () => {
            // MODIFICAR DASHBOARD POR DEFECTO

            // loadDashboardAndData('dashboard-comercializacion.html', 'vivo-aqp');
            // loadDashboardAndData('dashboard-comercializacion.html', 'vivo-provincia');
            // loadDashboardAndData('dashboard-huevo.html', 'huevo');

            // Criaderos Emprendedores:
            //loadDashboardAndData('dashboard-criadores-emprendedores.html', 'criador');

            // Tamaño de Mercado:
            // loadDashboardAndData('dashboard_tamanoMercado.html', 'tamanoMercado');

            // Potencial de Venta:
            // loadDashboardAndData('dashboard-capturas.html', 'vivo-arequipa');

            const frame = document.getElementById('dashboardFrame');
            frame.src = 'dashboard.html';
            document.getElementById('dashboardTitle').textContent = 'Dashboard Principal';

            // Ocultar loading cuando cargue
            frame.onload = () => {
                hideLoading();
            };
        });
        function toggleSidebarCollapse() {
            const sidebar = document.getElementById('sidebar');
            const contentWrapper = document.querySelector('.content-wrapper');

            sidebar.classList.toggle('collapsed');
            contentWrapper.classList.toggle('sidebar-collapsed');
        }
    </script>

    <script src="js/config/config.js"></script>
    <!-- <script src="js/services/comercializacion.service.js"></script>
    <script src="js/controllers/comercializacion.controller.js"></script>-->

    <script src="js/services/auth.service.js"></script>
    <script src="js/controllers/session.controller.js"></script>




</body>

</html>